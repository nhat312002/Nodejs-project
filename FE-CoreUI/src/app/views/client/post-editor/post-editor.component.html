<c-container class="py-4">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold m-0">{{ isEditMode() ? 'Edit Post' : 'New Post' }}</h2>
    <a routerLink="/profile/posts" cButton color="light">Cancel</a>
  </div>

  @if (isLoading()) {
  <div class="text-center py-5"><c-spinner></c-spinner></div>
  } @else {

  <form [formGroup]="form">
    <div class="row g-4">

      <!-- LEFT COLUMN: EDITOR -->
      <div class="col-lg-8">
        <c-card class="border-0 shadow-sm">
          <c-card-body class="p-4">

            <!-- 1. TITLE -->
            <div class="mb-3">
              <input cFormControl formControlName="title" placeholder="Enter title..."
                class="fs-3 fw-bold border-0 px-0 shadow-none"
                [class.is-invalid]="form.get('title')?.touched && form.get('title')?.invalid" />
              <div class="border-bottom"></div>
              @if (form.get('title')?.touched && form.get('title')?.invalid) {
              <div class="text-danger small mt-1">
                @if (form.get('title')?.hasError('required')) {
                Title is required.
                }
                @if (form.get('title')?.hasError('minlength')) {
                Title must be at least 3 characters.
                }
                @if (form.get('title')?.hasError('whitespace')) {
                Title must not be blank.
                }
              </div>
              }
            </div>

            <!-- 2. SUBTITLE -->
            <div class="mb-4">
              <textarea cFormControl formControlName="excerpt" rows="2" placeholder="Subtitle (optional)..."
                class="border-0 px-0 text-muted shadow-none" style="resize: none;"></textarea>
            </div>

            <!-- 3. TINYMCE EDITOR -->
            <div class="mb-3">
              @if (form.get('body')?.touched && form.get('body')?.invalid) {
              <div class="text-danger mt-1">Body is required.</div>
              }
              <editor [init]="editorConfig" formControlName="body"></editor>
              @if (form.get('body')?.touched && form.get('body')?.invalid) {
              <div class="text-danger mt-1">Body is required.</div>
              }
            </div>

          </c-card-body>
        </c-card>
      </div>

      <!-- RIGHT COLUMN: SETTINGS -->
      <div class="col-lg-4">
        <div class="" style="top: 20px;">

          <!-- A. PUBLISH ACTIONS -->
          <c-card class="border-0 shadow-sm mb-3">
            <c-card-body>
              <div class="d-grid gap-2">
                @if (saveError()) {
                <c-alert color="danger" class="mb-3 small p-2">
                  {{ saveError() }}
                </c-alert>
                }
                <!-- Save Draft -->
                <!-- <button cButton color="secondary" variant="ghost"
                          type="button"
                          [disabled]="isSubmitting()"
                          (click)="save()">
                    Save Draft
                  </button> -->

                <!-- Publish / Update -->
                <button cButton color="primary" class="fw-bold text-white" type="button" [disabled]="isSubmitting()"
                  (click)="save()">
                  @if (isSubmitting()) {
                  <c-spinner size="sm"></c-spinner> Saving...
                  } @else {
                  {{ isEditMode() ? 'Update' : 'Publish' }}
                  }
                </button>
              </div>
            </c-card-body>
          </c-card>

          <!-- B. METADATA -->
          <c-card class="border-0 shadow-sm">
            <c-card-body>
              <h6 class="fw-bold mb-3 text-muted text-uppercase small">Settings</h6>

              <!-- LANGUAGE PICKER -->
              <div class="mb-3">
                <label class="small fw-bold mb-1">Language</label>
                <select cSelect sizing="sm" formControlName="languageId">
                  <option [ngValue]="null" disabled>Select Language</option>
                  @for (lang of languages(); track lang.id) {
                  <option [value]="lang.id">{{ lang.name }}</option>
                  }
                </select>
              </div>

              <!-- CATEGORY PICKER (Dropdown with Checkboxes) -->
              <div class="mb-3">
                <label class="small fw-bold mb-1">Categories</label>

                <c-dropdown [autoClose]="'outside'" class="d-block">
                  <button cButton cDropdownToggle color="white" size="sm"
                    class="w-100 d-flex justify-content-between align-items-center border shadow-sm">
                    <span class="text-truncate" style="max-width: 90%;">
                      {{ categoryLabel() }}
                    </span>
                  </button>

                  <ul cDropdownMenu class="w-100 p-2 shadow-lg border-0 mt-1"
                    style="max-height: 250px; overflow-y: auto;">
                    @for (cat of categories(); track cat.id) {
                    <li class="ps-3 mb-1">
                      <c-form-check class="px-2 py-1 hover-bg-light rounded d-block">
                        <!-- Bind click to toggle function -->
                        <input cFormCheckInput type="checkbox" [id]="'cat-' + cat.id"
                          [checked]="isCategorySelected(cat.id)" (change)="toggleCategory(cat.id)">
                        <label cFormCheckLabel [for]="'cat-' + cat.id" class="w-100 cursor-pointer">
                          {{ cat.name }}
                        </label>
                      </c-form-check>
                    </li>
                    }
                  </ul>
                </c-dropdown>
              </div>

              <!-- COVER IMAGE -->
              <div class="mb-3">
                <label class="small fw-bold mb-1">Cover Image</label>

                <!-- Preview Area -->
                @if (previewUrl) {
                <div class="position-relative mb-2 group">
                  <img [src]="previewUrl | imgUrl" class="img-fluid rounded border w-100"
                    style="max-height: 150px; object-fit: cover;">
                  <!-- Remove Button -->
                  <button cButton color="danger" size="sm" class="position-absolute top-0 end-0 m-1 py-0 px-2 shadow-sm"
                    type="button" (click)="removeCover()">
                    &times;
                  </button>
                </div>
                }

                <input cFormControl type="file" sizing="sm" accept="image/*" (change)="onFileSelect($event)">
                <div class="form-text small">
                  If empty, we'll pick the first image from the post.
                </div>
              </div>

            </c-card-body>
          </c-card>

        </div>
      </div>

    </div>
  </form>
  }
</c-container>
