@if (isLoading()) {
<div class="d-flex justify-content-center align-items-center min-vh-50">
  <c-spinner color="primary"></c-spinner>
</div>
} @else if (post(); as p) {
<!-- === MANAGEMENT BAR (Owner/Admin Only) === -->
@if (mode() !== 'public') {
<div class="bg-warning-subtle border-bottom py-3 mb-4">
  <div class="container reading-container d-flex justify-content-between align-items-center">

    <!-- Left: Status Badge -->
    <div class="d-flex align-items-center gap-2">
      <span class="small fw-bold text-uppercase text-muted">Status:</span>
      @switch (p.status) {
      @case ('1') { <c-badge color="warning">Pending Review</c-badge> }
      @case ('2') { <c-badge color="success">Published</c-badge> }
      @case ('3') { <c-badge color="danger">Rejected</c-badge> }
      }
    </div>

    <!-- Right: Actions -->
    <div class="d-flex gap-2">

      <!-- OWNER MODE -->
      @if (mode() === 'owner') {
      <!-- Edit Button -->
      <a [routerLink]="['/profile/posts/edit', p.id]" cButton color="dark" variant="outline" size="sm">
        <svg cIcon name="cilPencil" size="sm" class="me-1"></svg> Edit
      </a>

      <!-- Delete Button -->
      <button cButton color="danger" variant="ghost" size="sm" (click)="deletePost()" [disabled]="isProcessing()">
        <svg cIcon name="cilTrash" size="sm"></svg>
      </button>
      }

      <!-- ADMIN MODE -->
      @if (mode() === 'admin') {
      <!-- You can add Approve/Reject buttons here,
                  or keep it read-only and manage via the list -->
      <a routerLink="/manage/posts" cButton color="secondary" size="sm">Back to List</a>
      }

    </div>
  </div>
</div>
}

<!-- === MAIN POST === -->
<article class="reading-container mx-auto px-3 py-5">

  <!-- HEADER -->
  <header class="mb-5 pb-4 border-bottom">
    @if (p.categories && p.categories.length > 0) {
    <!-- 1. Use d-flex to align items horizontally, flex-wrap for safety -->
    <div class="d-flex flex-wrap align-items-center mb-3">

      @for (cat of p.categories; track cat.id; let isLast = $last) {

      <!-- 2. Removed 'd-block' and 'mb-3'. Added 'link-hover' for style. -->
      <a [routerLink]="['/category', cat.id]" class="text-primary text-decoration-none fw-bold text-uppercase small">
        {{ cat.name }}
      </a>

      <!-- 3. Add Middot if it is NOT the last item -->
      @if (!isLast) {
      <span class="mx-2 text-muted">&middot;</span>
      }

      }
    </div>
    }
    <h1 class="fw-bold display-5 mb-4 text-dark font-serif">{{ p.title }}</h1>
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <a [routerLink]="['/profile', p.user.id]" class="text-decoration-none">
          <!-- Ensure your model uses user.avatarUrl (camelCase) -->
          <c-avatar [src]=" (p.user.url_avatar ) | imgUrl:'user'" size="md"></c-avatar>
        </a>
        <div class="d-flex flex-column" style="line-height: 1.2;">
          <a [routerLink]="['/profile', p.user.id]" class="text-dark text-decoration-none fw-bold">
            {{ p.user.fullName }}
          </a>
          <span class="text-muted small">
            {{ p.createdAt | date:'mediumDate' }}
          </span>
        </div>
      </div>
      <div class="d-flex gap-2">
        <button cButton color="light" variant="ghost" size="sm">
          <svg cIcon name="cilShareAlt"></svg>
        </button>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <div class="post-content font-serif fs-5" [innerHTML]="p.body"></div>

  <!-- FOOTER STATS -->
  <div class="d-flex gap-4 py-4 border-top border-bottom mt-5 text-muted">
    <div class="d-flex align-items-center gap-2 cursor-pointer">
      <svg cIcon name="cilHeart"></svg> <span>Like</span>
    </div>
    <div class="d-flex align-items-center gap-2 cursor-pointer">
      <svg cIcon name="cilCommentBubble"></svg> <span>{{ comments().length }} Comments</span>
    </div>
  </div>
</article>

<!-- === COMMENTS SECTION === -->
<section class="bg-light py-5">
  <div class="reading-container mx-auto px-3">
    <h4 class="fw-bold mb-4">Comments</h4>

    <!-- 1. WRITE COMMENT -->
    @if(p.status == '2'){

      <div class="mb-5 p-4 bg-white rounded shadow-sm border">
        @if (userProfileService.profile(); as user) {
        <div class="d-flex gap-3">
          <c-avatar [src]="(user.url_avatar || '') | imgUrl:'user'" size="md"></c-avatar>
          <div class="flex-grow-1">
            <div class="mb-2 fw-bold small text-muted">
              Commenting as <span class="text-dark">{{ user.full_name }}</span>
            </div>
            <textarea cFormControl rows="3" placeholder="What are your thoughts?" [ngModel]="newCommentText()"
              (ngModelChange)="newCommentText.set($any($event))" [disabled]="isSubmitting()">
                </textarea>
            <div class="d-flex justify-content-end mt-2">
              <button cButton color="primary" class="fw-bold rounded-pill px-4 text-white" (click)="submitMainComment()"
                [disabled]="!newCommentText().trim() || isSubmitting()">
                @if (isSubmitting()) { Posting... } @else { Post }
              </button>
            </div>
          </div>
        </div>
        } @else {
        <div class="text-center py-3">
          <h5 class="fw-bold text-muted mb-3">Join the conversation</h5>
          <a routerLink="/login" [queryParams]="{ returnUrl: router.url }" cButton color="primary"
            class="rounded-pill px-4 fw-bold text-white">
            Sign in to comment
          </a>
        </div>
        }
      </div>
    }

    <!-- 2. COMMENT LIST -->
    <div class="d-flex flex-column gap-4">
      @for (comment of comments(); track comment.id) {

      <div class="comment-item">
        <div class="d-flex gap-3">
          <c-avatar [src]="(comment.user.avatarUrl || '') | imgUrl:'user' " size="md"></c-avatar>

          <div class="flex-grow-1">

            <!-- HEADER ROW -->
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div>
                <span class="fw-bold text-dark me-2">{{ comment.user.fullName }}</span>
                <span class="text-muted small">{{ comment.createdAt | date:'mediumDate' }}</span>
              </div>

              <!-- MEATBALL MENU (Edit/Delete) -->
              @if (authService.currentUser(); as currentUser) {
              @if (currentUser.userId === comment.userId || currentUser.role === 3) {
              <c-dropdown direction="dropstart" variant="btn-group">
                <button cButton cDropdownToggle [caret]="false" color="light" variant="ghost" size="sm" class="p-0 text-muted border-0">
                  <svg cIcon name="cilOptions"></svg>
                </button>
                <ul cDropdownMenu class="shadow-sm border-0">
                  @if (currentUser.userId === comment.userId) {
                  <li><a cDropdownItem (click)="startEdit(comment)" class="small pointer"><svg cIcon name="cilPencil"
                        size="sm" class="me-2"></svg> Edit</a></li>
                  }
                  <li><a cDropdownItem (click)="deleteComment(comment.id)" class="small text-danger pointer"><svg cIcon
                        name="cilTrash" size="sm" class="me-2"></svg> Delete</a></li>
                </ul>
              </c-dropdown>
              }
              }
            </div>

            <!-- CONTENT AREA -->
            @if (editingCommentId() === comment.id) {
            <!-- Edit Mode -->
            <div class="mt-2">
              <textarea cFormControl rows="2" [ngModel]="editCommentText()"
                (ngModelChange)="editCommentText.set($any($event))"></textarea>
              <div class="d-flex gap-2 mt-2">
                <button cButton size="sm" color="primary" class="text-white"
                  (click)="saveEdit(comment.id)">Save</button>
                <button cButton size="sm" color="light" (click)="cancelEdit()">Cancel</button>
              </div>
            </div>
            } @else {
            <!-- Read Mode -->
            <p class="mb-2 text-dark" style="white-space: pre-wrap;">{{ comment.content }}</p>

            <!-- <div class="d-flex gap-3 align-items-center">
              <button class="btn btn-link p-0 text-decoration-none small text-muted fw-bold"
                (click)="startReply(comment)">
                <svg cIcon name="cilCommentBubble" size="sm" class="me-1"></svg> Reply
              </button>
            </div> -->
            }

            <!-- REPLY BOX (Injects here if active) -->
            @if (replyingToId() === comment.id) {
            <div class="mb-3 mt-2 ms-2 ps-3 border-start border-3 border-primary">
              <div class="mb-2 small text-muted">Replying to <span class="fw-bold">{{ comment.user.fullName }}</span>
              </div>
              <textarea cFormControl rows="2" placeholder="Write a reply..." [ngModel]="replyText()"
                (ngModelChange)="replyText.set($any($event))" [disabled]="isReplySubmitting()"></textarea>
              <div class="d-flex gap-2 mt-2">
                <button cButton size="sm" color="primary" class="text-white" (click)="submitReply(comment)"
                  [disabled]="!replyText().trim()">Reply</button>
                <button cButton size="sm" color="light" (click)="cancelReply()">Cancel</button>
              </div>
            </div>
            }

            @if (comment.replies && comment.replies.length > 0) {
            <div class="mt-3 ps-3 border-start border-3">
              @for (reply of comment.replies; track reply.id) {
              <div class="d-flex gap-3 mb-3">

                <!-- Reply Avatar -->
                <c-avatar [src]="(reply.user.avatarUrl || '') | imgUrl" size="sm"></c-avatar>

                <div class="flex-grow-1">

                  <!-- REPLY HEADER (Name, Date, Menu) -->
                  <div class="d-flex justify-content-between align-items-start mb-1">
                    <div class="d-flex align-items-center gap-2">
                      <span class="fw-bold small">{{ reply.user.fullName }}</span>
                      <span class="text-muted small" style="font-size: 0.75rem;">
                        {{ reply.createdAt | date:'mediumDate' }}
                      </span>
                    </div>

                    <!-- MEATBALL MENU FOR REPLY -->
                    @if (authService.currentUser(); as currentUser) {
                    @if (currentUser.userId === reply.userId || currentUser.role === 3) {
                    <c-dropdown direction="dropstart" variant="btn-group">
                      <button cButton cDropdownToggle color="light" variant="ghost" size="sm"
                        class="p-0 text-muted border-0" style="line-height: 1;">
                        <svg cIcon name="cilOptions" size="sm"></svg>
                      </button>
                      <ul cDropdownMenu class="shadow-sm border-0">
                        <!-- Edit (Owner Only) -->
                        @if (currentUser.userId === reply.userId) {
                        <li>
                          <a cDropdownItem (click)="startEdit(reply)" class="small pointer">
                            <svg cIcon name="cilPencil" size="sm" class="me-2"></svg> Edit
                          </a>
                        </li>
                        }
                        <!-- Delete (Owner or Admin) -->
                        <li>
                          <a cDropdownItem (click)="deleteComment(reply.id)" class="small text-danger pointer">
                            <svg cIcon name="cilTrash" size="sm" class="me-2"></svg> Delete
                          </a>
                        </li>
                      </ul>
                    </c-dropdown>
                    }
                    }
                  </div>

                  <!-- REPLY CONTENT (Read vs Edit) -->
                  @if (editingCommentId() === reply.id) {
                  <!-- Edit Mode -->
                  <div class="mt-2">
                    <textarea cFormControl rows="2" [ngModel]="editCommentText()"
                      (ngModelChange)="editCommentText.set($any($event))">
              </textarea>
                    <div class="d-flex gap-2 mt-2">
                      <button cButton size="sm" color="primary" class="text-white"
                        (click)="saveEdit(reply.id)">Save</button>
                      <button cButton size="sm" color="light" (click)="cancelEdit()">Cancel</button>
                    </div>
                  </div>
                  } @else {
                  <!-- Read Mode -->
                  <p class="mb-0 small text-dark" style="white-space: pre-wrap;">{{ reply.content }}</p>
                  }

                </div>
              </div>
              }
            </div>
            }

          </div>
        </div>
      </div>

      } @empty {
      <div class="text-center py-4 text-muted">No comments yet.</div>
      }
    </div>

    @if (hasMore()) {
    <div class="text-center mt-4">
      <button cButton color="light" variant="ghost" class="fw-bold text-primary rounded-pill px-4"
        (click)="onLoadMore()" [disabled]="isLoadingComments()">

        @if (isLoadingComments()) {
        <c-spinner size="sm" class="me-2"></c-spinner> Loading...
        } @else {
        Load more comments
        }
      </button>
    </div>
    }
  </div>
</section>

} @else {
<div class="text-center py-5">Post not found.</div>
}
